<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionar Inversiones - Portfolio Management</title>
    <script src="./js/header-loader.js"></script>
    <link rel="stylesheet" href="./css/global.css">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: #f5f5f5; 
            color: #293b36;
        }
        
        .main-content {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .page-header {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #dc3545;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .page-title {
            margin: 0 0 10px 0;
            font-size: 28px;
            font-weight: 700;
            color: #293b36;
        }
        
        .page-subtitle {
            margin: 0;
            color: #666;
            font-size: 16px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .cash-info { 
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%); 
            color: white; 
            padding: 15px; 
            border-radius: 8px; 
            text-align: center; 
            min-width: 160px;
        }
        .cash-balance { font-size: 24px; font-weight: 700; }
        .cash-label { font-size: 14px; opacity: 0.9; }

        .investments-grid { display: grid; gap: 20px; }
        .investment-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .investment-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .stock-symbol { font-size: 24px; font-weight: bold; color: #333; }
        .company-name { color: #666; font-size: 14px; }
        .current-price { font-size: 20px; font-weight: bold; }
        .price-change { font-size: 14px; }
        .change-positive { color: #28a745; }
        .change-negative { color: #dc3545; }
        .investment-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .detail-item { text-align: center; }
        .detail-value { font-size: 18px; font-weight: bold; color: #333; }
        .detail-label { font-size: 12px; color: #666; }
        .sell-section { background: #f8f9fa; padding: 15px; border-radius: 8px; }
        .form-group { margin-bottom: 15px; }
        .form-row { display: flex; gap: 10px; align-items: end; }
        .form-row input { flex: 1; }
        label { display: block; margin-bottom: 5px; color: #555; font-weight: bold; }
        input[type="number"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-sell { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; font-weight: 700; }
        .btn-sell:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(220,53,69,0.4); }
        .btn-secondary { background: #6c757d; color: white; font-weight: 700; }
        .btn-success { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; font-weight: 700; }
        .message { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .no-investments { text-align: center; padding: 40px; color: #666; }
        .total-estimate { font-size: 16px; font-weight: bold; margin-top: 10px; }
        
        /* Modal de confirmaci√≥n personalizado */
        .confirmation-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            padding: 0;
            min-width: 400px;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -60%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }
        
        .modal-header {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 20px 25px;
            border-radius: 15px 15px 0 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .modal-icon {
            font-size: 32px;
            opacity: 0.9;
        }
        
        .modal-title {
            margin: 0;
            font-size: 20px;
            font-weight: bold;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .warning-message {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sale-details {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .sale-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .sale-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
            margin-top: 10px;
            padding-top: 15px;
            border-top: 2px solid #dc3545;
            font-weight: bold;
            font-size: 16px;
        }
        
        .sale-label {
            color: #666;
            font-weight: 500;
        }
        
        .sale-value {
            font-weight: bold;
            color: #333;
        }
        
        .profit-loss-positive {
            color: #28a745;
        }
        
        .profit-loss-negative {
            color: #dc3545;
        }
        
        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding: 0 25px 25px 25px;
        }
        
        .modal-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            min-width: 100px;
        }
        
        .modal-btn-cancel {
            background: #6c757d;
            color: white;
        }
        
        .modal-btn-cancel:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        .modal-btn-confirm {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }
        
        .modal-btn-confirm:hover {
            background: linear-gradient(135deg, #c82333 0%, #a71e2a 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220,53,69,0.4);
        }
        
        .modal-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* Animaci√≥n de salida */
        .modal-content.closing {
            animation: modalSlideOut 0.3s ease-in;
        }
        
        @keyframes modalSlideOut {
            from {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
            to {
                opacity: 0;
                transform: translate(-50%, -60%);
            }
        }
        
        /* Responsive */
        @media (max-width: 500px) {
            .modal-content {
                min-width: 90%;
                margin: 20px;
            }
            
            .modal-actions {
                flex-direction: column;
            }
            
            .modal-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="main-content">
        <div class="page-header">
            <div>
                <h1 class="page-title">üìà Gestionar Inversiones</h1>
                <p class="page-subtitle">Administra y vende tus acciones</p>
            </div>
            <div class="header-actions">
                <div class="cash-info">
                    <div class="cash-label">Dinero Disponible</div>
                    <div class="cash-balance" id="cashBalance">$0.00</div>
                </div>
                <button class="btn btn-success" onclick="showAddCashModal()">üí∞ Agregar Dinero</button>
            </div>
        </div>

        <div id="investmentsList" class="investments-grid">
            <div class="loading">Cargando inversiones...</div>
        </div>

        <div id="message"></div>
    </div>

    <!-- Add Cash Modal -->
    <div id="addCashModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; min-width: 300px;">
            <h3>Agregar Dinero a la Cuenta</h3>
            <div class="form-group">
                <label for="cashAmount">Cantidad:</label>
                <input type="number" id="cashAmount" min="1" step="0.01" placeholder="0.00">
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeAddCashModal()">Cancelar</button>
                <button class="btn btn-success" onclick="addCash()">Agregar</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="confirmation-modal">
        <div class="modal-content" id="modalContent">
            <div class="modal-header">
                <span class="modal-icon">‚ö†Ô∏è</span>
                <h3 class="modal-title">Confirmar Venta de Acciones</h3>
            </div>
            <div class="modal-body">
                <div class="warning-message">
                    <span>‚ö°</span>
                    <span>Esta acci√≥n no se puede deshacer. Aseg√∫rate de que los detalles sean correctos.</span>
                </div>
                
                <div id="saleDetailsContainer" class="sale-details">
                    <!-- Los detalles se llenar√°n din√°micamente -->
                </div>
                
                <p style="color: #666; font-size: 14px; text-align: center; margin: 15px 0 0 0;">
                    ¬øEst√°s seguro de que deseas proceder con esta venta?
                </p>
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-cancel" onclick="closeConfirmationModal()">
                    ‚ùå Cancelar
                </button>
                <button class="modal-btn modal-btn-confirm" id="confirmSellBtn" onclick="confirmSale()">
                    ‚úÖ Confirmar Venta
                </button>
            </div>
        </div>
    </div>

    <script>
        const userId = localStorage.getItem('userId');
        let isLoading = false;
        let pendingSaleData = null;

        if (!userId) {
            window.location.href = 'login.html';
        }

        async function loadInvestments() {
            if (isLoading) return;
            isLoading = true;
            
            try {
                const [investmentsResponse, cashResponse] = await Promise.all([
                    fetch('/api/investments/', {
                        headers: { 'x-user-id': userId }
                    }),
                    fetch('/api/investments/cash/balance', {
                        headers: { 'x-user-id': userId }
                    })
                ]);

                const investmentsResult = await investmentsResponse.json();
                const cashResult = await cashResponse.json();

                // Update cash balance display with null check
                if (cashResult.success) {
                    const cashBalanceElement = document.getElementById('cashBalance');
                    if (cashBalanceElement) {
                        cashBalanceElement.textContent = `$${parseFloat(cashResult.data.cashBalance).toLocaleString()}`;
                    } else {
                        console.warn('Cash balance element not found in DOM');
                    }
                    
                    // Update header balance if available
                    if (window.headerLoader && window.headerLoader.updateCashBalance) {
                        window.headerLoader.updateCashBalance(cashResult.data.cashBalance);
                    }
                }

                if (investmentsResult.success && investmentsResult.data.length > 0) {
                    displayInvestments(investmentsResult.data);
                } else {
                    const investmentsList = document.getElementById('investmentsList');
                    if (investmentsList) {
                        investmentsList.innerHTML = `
                            <div class="no-investments">
                                <h3>No tienes inversiones a√∫n</h3>
                                <p>¬°Comienza comprando tu primera acci√≥n!</p>
                                <button class="btn btn-success" onclick="window.location.href='buy-stocks.html'">
                                    Comprar Acciones
                                </button>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error loading investments:', error);
                showMessage('Error cargando inversiones', 'error');
            } finally {
                isLoading = false;
            }
        }

        function displayInvestments(investments) {
            const container = document.getElementById('investmentsList');
            
            container.innerHTML = investments.map(investment => {
                const currentValue = parseFloat(investment.currentValue || 0);
                const gainLoss = parseFloat(investment.gainLoss || 0);
                const gainLossPercent = parseFloat(investment.gainLossPercent || 0);
                const gainLossClass = gainLoss >= 0 ? 'change-positive' : 'change-negative';
                
                return `
                    <div class="investment-card">
                        <div class="investment-header">
                            <div>
                                <div class="stock-symbol">${investment.symbol}</div>
                                <div class="company-name">${investment.companyName || 'N/A'}</div>
                            </div>
                            <div style="text-align: right;">
                                <div class="current-price">$${parseFloat(investment.currentPrice || investment.purchasePrice).toFixed(2)}</div>
                                <div class="price-change ${gainLossClass}">
                                    ${gainLoss >= 0 ? '+' : ''}$${gainLoss} (${gainLossPercent >= 0 ? '+' : ''}${gainLossPercent}%)
                                </div>
                            </div>
                        </div>
                        
                        <div class="investment-details">
                            <div class="detail-item">
                                <div class="detail-value">${investment.quantity}</div>
                                <div class="detail-label">Acciones</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-value">$${parseFloat(investment.purchasePrice).toFixed(2)}</div>
                                <div class="detail-label">Precio Promedio</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-value">$${parseFloat(investment.totalInvested).toFixed(2)}</div>
                                <div class="detail-label">Total Invertido</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-value">$${currentValue.toFixed(2)}</div>
                                <div class="detail-label">Valor Actual</div>
                            </div>
                        </div>
                        
                        <div class="sell-section">
                            <h4>Vender Acciones</h4>
                            <div class="form-row">
                                <div style="flex: 2;">
                                    <label for="sellQuantity_${investment.id}">Cantidad a vender:</label>
                                    <input type="number" id="sellQuantity_${investment.id}" 
                                           min="1" max="${investment.quantity}" value="1"
                                           onchange="updateSellEstimate(${investment.id}, ${investment.currentPrice || investment.purchasePrice})">
                                </div>
                                <button class="btn btn-sell" onclick="sellStock(${investment.id})">
                                    Vender
                                </button>
                            </div>
                            <div class="total-estimate" id="sellEstimate_${investment.id}">
                                Estimado: $${parseFloat(investment.currentPrice || investment.purchasePrice).toFixed(2)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateSellEstimate(investmentId, currentPrice) {
            const quantity = parseInt(document.getElementById(`sellQuantity_${investmentId}`).value) || 0;
            const estimate = (quantity * currentPrice).toFixed(2);
            document.getElementById(`sellEstimate_${investmentId}`).textContent = `Estimado: $${estimate}`;
        }

        async function sellStock(investmentId) {
            const quantityInput = document.getElementById(`sellQuantity_${investmentId}`);
            if (!quantityInput) {
                showMessage('Error: elemento de cantidad no encontrado', 'error');
                return;
            }
            
            const quantity = parseInt(quantityInput.value);
            
            if (!quantity || quantity <= 0) {
                showMessage('Ingresa una cantidad v√°lida para vender', 'error');
                return;
            }
            
            // Encontrar los datos de la inversi√≥n
            const investmentCard = quantityInput.closest('.investment-card');
            const symbol = investmentCard.querySelector('.stock-symbol').textContent;
            const companyName = investmentCard.querySelector('.company-name').textContent;
            const currentPriceText = investmentCard.querySelector('.current-price').textContent;
            const currentPrice = parseFloat(currentPriceText.replace('$', '').replace(',', ''));
            
            // Calcular detalles de la venta
            const totalSaleValue = currentPrice * quantity;
            
            // Guardar datos para la venta
            pendingSaleData = {
                investmentId: investmentId,
                quantity: quantity,
                symbol: symbol,
                companyName: companyName,
                currentPrice: currentPrice,
                totalSaleValue: totalSaleValue
            };
            
            // Mostrar modal de confirmaci√≥n
            showConfirmationModal();
        }

        function showConfirmationModal() {
            if (!pendingSaleData) return;
            
            const { symbol, companyName, quantity, currentPrice, totalSaleValue } = pendingSaleData;
            
            // Crear contenido del modal
            const saleDetailsHTML = `
                <div class="sale-item">
                    <span class="sale-label">üìä Acci√≥n:</span>
                    <span class="sale-value">${symbol} - ${companyName}</span>
                </div>
                <div class="sale-item">
                    <span class="sale-label">üìà Cantidad a vender:</span>
                    <span class="sale-value">${quantity} acciones</span>
                </div>
                <div class="sale-item">
                    <span class="sale-label">üí∞ Precio actual:</span>
                    <span class="sale-value">$${currentPrice.toFixed(2)} por acci√≥n</span>
                </div>
                <div class="sale-item">
                    <span class="sale-label">üíµ Total a recibir:</span>
                    <span class="sale-value profit-loss-positive">$${totalSaleValue.toLocaleString()}</span>
                </div>
            `;
            
            document.getElementById('saleDetailsContainer').innerHTML = saleDetailsHTML;
            document.getElementById('confirmationModal').style.display = 'block';
            
            // A√±adir animaci√≥n de entrada
            setTimeout(() => {
                document.getElementById('modalContent').style.animation = 'modalSlideIn 0.3s ease-out';
            }, 10);
        }

        function closeConfirmationModal() {
            const modalContent = document.getElementById('modalContent');
            modalContent.classList.add('closing');
            
            setTimeout(() => {
                document.getElementById('confirmationModal').style.display = 'none';
                modalContent.classList.remove('closing');
                pendingSaleData = null;
            }, 300);
        }

        async function confirmSale() {
            if (!pendingSaleData) return;
            
            const confirmBtn = document.getElementById('confirmSellBtn');
            const originalText = confirmBtn.innerHTML;
            
            // Deshabilitar bot√≥n y mostrar loading
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '‚è≥ Procesando...';
            
            try {
                const response = await fetch(`/api/investments/${pendingSaleData.investmentId}/sell`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-user-id': userId
                    },
                    body: JSON.stringify({ quantity: pendingSaleData.quantity })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const profitLoss = parseFloat(result.data.saleDetails.profitLoss || result.data.profitLoss || 0);
                    const profitLossPercent = parseFloat(result.data.saleDetails.profitLossPercent || result.data.profitLossPercent || 0);
                    const profitLossClass = profitLoss >= 0 ? 'success' : 'error';
                    const profitLossText = profitLoss >= 0 ? 'Ganancia' : 'P√©rdida';
                    
                    // Cerrar modal
                    closeConfirmationModal();
                    
                    // Mostrar mensaje de √©xito
                    showMessage(`
                        <div style="text-align: center;">
                            <div style="font-size: 20px; margin-bottom: 10px;">‚úÖ ¬°Venta Exitosa!</div>
                            <div><strong>${result.message}</strong></div>
                            <div style="margin: 15px 0; padding: 15px; background: ${profitLoss >= 0 ? '#d4edda' : '#f8d7da'}; border-radius: 8px;">
                                <div style="font-size: 16px;"><strong>${profitLossText}:</strong> 
                                    <span style="color: ${profitLoss >= 0 ? '#28a745' : '#dc3545'};">
                                        ${profitLoss >= 0 ? '+' : ''}$${Math.abs(profitLoss).toFixed(2)} 
                                        (${profitLossPercent >= 0 ? '+' : ''}${profitLossPercent.toFixed(2)}%)
                                    </span>
                                </div>
                            </div>
                            <div><strong>Nuevo balance:</strong> $${parseFloat(result.data.newCashBalance).toLocaleString()}</div>
                        </div>
                    `, profitLossClass);
                    
                    // Update header balance
                    if (window.headerLoader && window.headerLoader.updateCashBalance) {
                        window.headerLoader.updateCashBalance(result.data.newCashBalance);
                    }

                    setTimeout(() => {
                        loadInvestments();
                    }, 2000);
                } else {
                    showMessage(result.message, 'error');
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = originalText;
                }
            } catch (error) {
                console.error('Error selling stock:', error);
                showMessage('Error vendiendo acciones', 'error');
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = originalText;
            }
        }

        // Cerrar modal al hacer clic fuera de √©l
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('confirmationModal');
            if (e.target === modal) {
                closeConfirmationModal();
            }
        });

        // Cerrar modal con tecla Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('confirmationModal');
                if (modal.style.display === 'block') {
                    closeConfirmationModal();
                }
            }
        });

        async function addCash() {
            const cashAmountInput = document.getElementById('cashAmount');
            if (!cashAmountInput) {
                showMessage('Error: elemento de cantidad no encontrado', 'error');
                return;
            }
            
            const amount = parseFloat(cashAmountInput.value);
            
            if (!amount || amount <= 0) {
                showMessage('Ingresa una cantidad v√°lida', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/investments/cash/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-user-id': userId
                    },
                    body: JSON.stringify({ amount })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    
                    // Update cash balance display with null check
                    const cashBalanceElement = document.getElementById('cashBalance');
                    if (cashBalanceElement) {
                        cashBalanceElement.textContent = `$${parseFloat(result.data.newBalance).toLocaleString()}`;
                    }
                    
                    closeAddCashModal();
                    
                    // Update header balance
                    if (window.headerLoader && window.headerLoader.updateCashBalance) {
                        window.headerLoader.updateCashBalance(result.data.newBalance);
                    }

                    setTimeout(() => {
                        loadInvestments();
                    }, 500);
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                console.error('Error adding cash:', error);
                showMessage('Error agregando dinero', 'error');
            }
        }

        function showAddCashModal() {
            document.getElementById('addCashModal').style.display = 'block';
        }

        function closeAddCashModal() {
            const modal = document.getElementById('addCashModal');
            const cashAmountInput = document.getElementById('cashAmount');
            
            if (modal) {
                modal.style.display = 'none';
            }
            
            if (cashAmountInput) {
                cashAmountInput.value = '';
            }
        }

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            if (messageDiv) {
                messageDiv.innerHTML = `<div class="message ${type}">${text}</div>`;
                
                setTimeout(() => {
                    if (messageDiv.innerHTML.includes(text)) {
                        messageDiv.innerHTML = '';
                    }
                }, 10000);
            } else {
                console.warn('Message div not found, message:', text);
            }
        }

        // Initialize with DOM ready check
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadInvestments);
        } else {
            // DOM already loaded
            setTimeout(loadInvestments, 100);
        }
    </script>
</body>
</html>
