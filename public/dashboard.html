<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Portfolio Management</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="./js/header-loader.js"></script>
    <link rel="stylesheet" href="./css/global.css">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background-color: #f5f5f5; 
            color: #293b36;
        }
        
        /* Adjust for header */
        .main-content {
            margin-top: 20px;
        }
        
        .welcome-section { 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            margin-bottom: 20px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
        }
        
        .welcome-title {
            color: #293b36;
            margin: 0 0 10px 0;
            font-size: 28px;
            font-weight: 700;
        }
        
        .welcome-subtitle {
            color: #666;
            margin: 0;
            font-size: 16px;
        }
        
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .action-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .action-card h3 { 
            margin-top: 0; 
            color: #293b36; 
            font-weight: 700; 
        }
        
        .action-card button { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            width: 100%; 
            font-weight: 700; 
        }
        
        .action-card button:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 25px rgba(0,0,0,0.15); 
        }

        /* Portfolio Analysis Styles */
        .portfolio-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #28a745;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            color: #293b36;
            margin: 0;
            font-size: 24px;
            font-weight: 700;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .portfolio-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .summary-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }

        .summary-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .investments-table {
            overflow-x: auto;
            margin-bottom: 25px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #293b36;
        }

        .gain-positive {
            color: #28a745;
            font-weight: bold;
        }

        .gain-negative {
            color: #dc3545;
            font-weight: bold;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .chart-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .chart-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .chart-wrapper {
            position: relative;
            height: 250px;
        }

        .no-investments {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }

        .investment-story {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .story-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .story-text {
            font-size: 14px;
            line-height: 1.6;
            opacity: 0.9;
        }

        .highlight {
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .portfolio-summary {
                grid-template-columns: 1fr;
            }

            .charts-container {
                grid-template-columns: 1fr;
            }

            .stats-overview {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="main-content">
        <div class="welcome-section">
            <h1 class="welcome-title">¬°Bienvenido de vuelta, <span id="userName"></span>!</h1>
            <p class="welcome-subtitle">Gestiona tu portafolio y mantente al d√≠a con tus inversiones</p>
        </div>
        
        <div class="stats-overview">
            <div class="stat-card" onclick="scrollToPortfolio()">
                <div class="stat-value" id="quickTotalValue">$0.00</div>
                <div class="stat-label">Valor Total</div>
            </div>
            <div class="stat-card" onclick="scrollToPortfolio()">
                <div class="stat-value" id="quickInvestmentCount">0</div>
                <div class="stat-label">Inversiones</div>
            </div>
            <div class="stat-card" onclick="window.location.href='buy-stocks.html'">
                <div class="stat-value" id="quickCashBalance">$0.00</div>
                <div class="stat-label">Efectivo</div>
            </div>
            <div class="stat-card" onclick="window.location.href='market.html'">
                <div class="stat-value">üìä</div>
                <div class="stat-label">Ver Mercado</div>
            </div>
        </div>
        
        <div class="quick-actions">
            <div class="action-card">
                <h3>üí∞ Comprar Acciones</h3>
                <p>Busca y compra nuevas acciones para tu portafolio</p>
                <button onclick="window.location.href='buy-stocks.html'">Ir a Comprar</button>
            </div>
            
            <div class="action-card">
                <h3>üìà Gestionar Inversiones</h3>
                <p>Vende o administra tus inversiones actuales</p>
                <button onclick="window.location.href='manage-investments.html'">Gestionar</button>
            </div>

            <div class="action-card">
                <h3>üè™ Explorar Mercado</h3>
                <p>Descubre nuevas oportunidades de inversi√≥n</p>
                <button onclick="window.location.href='market.html'">Ver Mercado</button>
            </div>
        </div>

        <!-- Portfolio Analysis Section - Now Always Visible -->
        <div id="portfolioSection" class="portfolio-section">
            <div class="section-header">
                <h2 class="section-title">üìä An√°lisis de Portafolio</h2>
                <button class="refresh-btn" onclick="loadPortfolio()">üîÑ Actualizar</button>
            </div>
            
            <div id="portfolioContent">
                <div class="loading">Cargando an√°lisis del portafolio...</div>
            </div>
        </div>
    </div>

    <script>
        const userId = localStorage.getItem('userId');
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        let portfolioCharts = {};
        
        if (!userId) {
            window.location.href = 'login.html';
        }
        
        document.getElementById('userName').textContent = user.firstName || user.username || 'Usuario';
        
        function scrollToPortfolio() {
            document.getElementById('portfolioSection').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }
        
        async function loadPortfolio() {
            const contentDiv = document.getElementById('portfolioContent');
            contentDiv.innerHTML = '<div class="loading">Actualizando an√°lisis del portafolio...</div>';
            
            try {
                const [portfolioResponse, investmentsResponse] = await Promise.all([
                    fetch('/api/portfolio/', {
                        headers: { 'x-user-id': userId }
                    }),
                    fetch('/api/investments/', {
                        headers: { 'x-user-id': userId }
                    })
                ]);
                
                const portfolioData = await portfolioResponse.json();
                const investmentsData = await investmentsResponse.json();
                
                if (portfolioData.success && investmentsData.success) {
                    displayPortfolioData(portfolioData.data, investmentsData.data);
                } else {
                    contentDiv.innerHTML = '<div class="error">Error cargando datos del portfolio</div>';
                }
            } catch (error) {
                contentDiv.innerHTML = '<div class="error">Error de conexi√≥n al cargar el portfolio</div>';
                console.error('Error loading portfolio:', error);
            }
        }
        
        async function loadQuickStats() {
            try {
                const [portfolioResponse, investmentsResponse, cashResponse] = await Promise.all([
                    fetch('/api/portfolio/', { headers: { 'x-user-id': userId } }),
                    fetch('/api/investments/', { headers: { 'x-user-id': userId } }),
                    fetch('/api/investments/cash/balance', { headers: { 'x-user-id': userId } })
                ]);

                const portfolioData = await portfolioResponse.json();
                const investmentsData = await investmentsResponse.json();
                const cashData = await cashResponse.json();

                if (portfolioData.success) {
                    document.getElementById('quickTotalValue').textContent = 
                        `$${parseFloat(portfolioData.data.totalPortfolioValue || 0).toLocaleString()}`;
                }

                if (investmentsData.success) {
                    document.getElementById('quickInvestmentCount').textContent = 
                        investmentsData.data.length || 0;
                }

                if (cashData.success) {
                    document.getElementById('quickCashBalance').textContent = 
                        `$${parseFloat(cashData.data.cashBalance || 0).toLocaleString()}`;
                    
                    if (window.headerLoader) {
                        window.headerLoader.updateCashBalance(cashData.data.cashBalance);
                    }
                }
            } catch (error) {
                console.error('Error loading quick stats:', error);
            }
        }

        function displayPortfolioData(portfolioData, investments) {
            const contentDiv = document.getElementById('portfolioContent');
            
            // Portfolio summary
            const summaryHTML = `
                <div class="portfolio-summary">
                    <div class="summary-card">
                        <div class="summary-label">Efectivo Disponible</div>
                        <div class="summary-value">$${parseFloat(portfolioData.cashBalance || 0).toLocaleString()}</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Total Invertido</div>
                        <div class="summary-value">$${parseFloat(portfolioData.totalInvested || 0).toLocaleString()}</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Valor Actual</div>
                        <div class="summary-value">$${parseFloat(portfolioData.currentPortfolioValue || 0).toLocaleString()}</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Ganancia/P√©rdida</div>
                        <div class="summary-value ${(portfolioData.totalGainLoss || 0) >= 0 ? 'gain-positive' : 'gain-negative'}">
                            ${(portfolioData.totalGainLoss || 0) >= 0 ? '+' : ''}$${parseFloat(portfolioData.totalGainLoss || 0).toLocaleString()}
                        </div>
                    </div>
                </div>
            `;

            // Investment story
            const storyHTML = generateInvestmentStory(portfolioData);

            // Investments table
            let investmentsHTML = '';
            if (portfolioData.investments && portfolioData.investments.length > 0) {
                const tableRows = portfolioData.investments.map(investment => {
                    const gainLossClass = investment.gainLoss >= 0 ? 'gain-positive' : 'gain-negative';
                    const gainLossSign = investment.gainLoss >= 0 ? '+' : '';
                    return `
                        <tr>
                            <td><strong>${investment.symbol}</strong><br><small>${investment.companyName || 'N/A'}</small></td>
                            <td>${investment.quantity}</td>
                            <td>$${parseFloat(investment.purchasePrice).toFixed(2)}</td>
                            <td>$${parseFloat(investment.currentPrice).toFixed(2)}</td>
                            <td>$${parseFloat(investment.totalInvested).toFixed(2)}</td>
                            <td>$${parseFloat(investment.currentValue).toFixed(2)}</td>
                            <td class="${gainLossClass}">
                                ${gainLossSign}$${Math.abs(investment.gainLoss).toFixed(2)}<br>
                                <small>(${gainLossSign}${investment.gainLossPercent.toFixed(2)}%)</small>
                            </td>
                            <td>
                                <button onclick="window.location.href='manage-investments.html'" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    Gestionar
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

                investmentsHTML = `
                    <h3 style="color: #293b36; margin-bottom: 15px;">üìà Mis Inversiones</h3>
                    <div class="investments-table">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Acci√≥n</th>
                                    <th>Cantidad</th>
                                    <th>Precio Promedio</th>
                                    <th>Precio Actual</th>
                                    <th>Total Invertido</th>
                                    <th>Valor Actual</th>
                                    <th>Ganancia/P√©rdida</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                investmentsHTML = `
                    <div class="no-investments">
                        <h3>üìã No tienes inversiones a√∫n</h3>
                        <p>¬°Comienza comprando tu primera acci√≥n para ver an√°lisis detallados!</p>
                        <button onclick="window.location.href='buy-stocks.html'" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 15px;">
                            üí∞ Comprar Primera Acci√≥n
                        </button>
                    </div>
                `;
            }

            // Charts section
            const chartsHTML = `
                <div class="charts-container">
                    <div class="chart-card">
                        <div class="chart-title">üìä Distribuci√≥n del Portafolio</div>
                        <div class="chart-wrapper">
                            <canvas id="portfolioDistributionChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">üìà Rendimiento por Inversi√≥n</div>
                        <div class="chart-wrapper">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>
                </div>
            `;

            contentDiv.innerHTML = summaryHTML + storyHTML + investmentsHTML + chartsHTML;

            // Create charts after DOM update
            setTimeout(() => {
                createPortfolioCharts(portfolioData);
            }, 100);
        }

        function generateInvestmentStory(portfolioData) {
            const totalValue = parseFloat(portfolioData.totalPortfolioValue || 0);
            const totalInvested = parseFloat(portfolioData.totalInvested || 0);
            const totalGainLoss = parseFloat(portfolioData.totalGainLoss || 0);
            const cashBalance = parseFloat(portfolioData.cashBalance || 0);
            const investmentCount = portfolioData.investmentCount || 0;

            let story = '';
            
            if (investmentCount === 0) {
                story = `Tu viaje de inversi√≥n est√° a punto de comenzar. Tienes <span class="highlight">$${cashBalance.toLocaleString()}</span> disponibles para realizar tu primera inversi√≥n. ¬°Es el momento perfecto para explorar el mercado y encontrar oportunidades!`;
            } else {
                const performanceText = totalGainLoss >= 0 ? 'excelente progreso' : 'una oportunidad de aprendizaje';
                const performanceEmoji = totalGainLoss >= 0 ? 'üöÄ' : 'üìà';
                const diversificationText = investmentCount === 1 ? 'Considera diversificar con m√°s acciones' : `Tienes un portafolio diversificado con ${investmentCount} inversiones`;
                
                story = `${performanceEmoji} Tu portafolio muestra ${performanceText} con un valor total de <span class="highlight">$${totalValue.toLocaleString()}</span>. 
                Has invertido <span class="highlight">$${totalInvested.toLocaleString()}</span> y actualmente tienes ${totalGainLoss >= 0 ? 'una ganancia' : 'una variaci√≥n'} de 
                <span class="highlight">${totalGainLoss >= 0 ? '+' : ''}$${totalGainLoss.toLocaleString()}</span>. 
                ${diversificationText} y mantienes <span class="highlight">$${cashBalance.toLocaleString()}</span> en efectivo para futuras oportunidades.`;
            }

            return `
                <div class="investment-story">
                    <div class="story-title">üìñ Historia de tu Portafolio</div>
                    <div class="story-text">${story}</div>
                </div>
            `;
        }

        function createPortfolioCharts(portfolioData) {
            // Destroy existing charts
            Object.values(portfolioCharts).forEach(chart => {
                if (chart) chart.destroy();
            });
            portfolioCharts = {};

            // Portfolio Distribution Chart
            const distributionCtx = document.getElementById('portfolioDistributionChart');
            if (distributionCtx && portfolioData.investments && portfolioData.investments.length > 0) {
                const labels = ['Efectivo', ...portfolioData.investments.map(inv => inv.symbol)];
                const data = [portfolioData.cashBalance, ...portfolioData.investments.map(inv => inv.currentValue)];
                const colors = [
                    '#28a745',
                    '#007bff', '#dc3545', '#ffc107', '#17a2b8', '#6f42c1',
                    '#fd7e14', '#20c997', '#e83e8c', '#6c757d', '#343a40'
                ];

                portfolioCharts.distribution = new Chart(distributionCtx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors.slice(0, labels.length),
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    usePointStyle: true,
                                    font: { size: 12 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const percentage = ((context.parsed / data.reduce((a, b) => a + b, 0)) * 100).toFixed(1);
                                        return `${context.label}: $${context.parsed.toLocaleString()} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            } else if (distributionCtx) {
                distributionCtx.getContext('2d').clearRect(0, 0, distributionCtx.width, distributionCtx.height);
                const parent = distributionCtx.parentElement;
                parent.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">No hay datos para mostrar</div>';
            }

            // Performance Chart
            const performanceCtx = document.getElementById('performanceChart');
            if (performanceCtx && portfolioData.investments && portfolioData.investments.length > 0) {
                const symbols = portfolioData.investments.map(inv => inv.symbol);
                const percentages = portfolioData.investments.map(inv => inv.gainLossPercent);
                const colors = percentages.map(p => p >= 0 ? '#28a745' : '#dc3545');

                portfolioCharts.performance = new Chart(performanceCtx, {
                    type: 'bar',
                    data: {
                        labels: symbols,
                        datasets: [{
                            label: 'Rendimiento (%)',
                            data: percentages,
                            backgroundColor: colors,
                            borderWidth: 1,
                            borderColor: colors
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${context.parsed.y >= 0 ? '+' : ''}${context.parsed.y.toFixed(2)}%`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                },
                                grid: { color: 'rgba(0,0,0,0.1)' }
                            },
                            x: {
                                grid: { display: false }
                            }
                        }
                    }
                });
            } else if (performanceCtx) {
                performanceCtx.getContext('2d').clearRect(0, 0, performanceCtx.width, performanceCtx.height);
                const parent = performanceCtx.parentElement;
                parent.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">No hay datos para mostrar</div>';
            }
        }

        // Initialize everything when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Load quick stats immediately
            loadQuickStats();
            
            // Load full portfolio analysis
            setTimeout(() => {
                loadPortfolio();
            }, 500);

            // Refresh every 5 minutes
            setInterval(() => {
                loadQuickStats();
                loadPortfolio();
            }, 5 * 60 * 1000);
        });
    </script>
</body>
</html>
