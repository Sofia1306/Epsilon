<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalles de Acci√≥n - Portfolio Management</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .stock-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        .stock-info { flex: 1; }
        .stock-symbol { font-size: 32px; font-weight: bold; color: #333; margin-bottom: 5px; }
        .company-name { font-size: 18px; color: #666; margin-bottom: 10px; }
        .current-price { font-size: 36px; font-weight: bold; color: #333; margin-bottom: 5px; }
        .price-change { font-size: 18px; }
        .change-positive { color: #28a745; }
        .change-negative { color: #dc3545; }
        .action-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn { padding: 12px 24px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; text-decoration: none; display: inline-block; transition: all 0.2s; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .stat-card h3 { margin-top: 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .stat-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .stat-item:last-child { border-bottom: none; }
        .stat-label { color: #666; }
        .stat-value { font-weight: bold; color: #333; }
        
        .chart-section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .chart-controls { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .chart-group { display: flex; flex-direction: column; min-width: 150px; }
        .chart-group label { font-size: 12px; color: #666; margin-bottom: 5px; }
        .chart-group select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .quick-range-buttons { display: flex; flex-wrap: wrap; gap: 5px; }
        .quick-range-btn { padding: 6px 12px; border: 1px solid #007bff; background: white; color: #007bff; border-radius: 4px; cursor: pointer; font-size: 12px; transition: all 0.2s; }
        .quick-range-btn:hover { background: #e7f3ff; }
        .quick-range-btn.active { background: #007bff; color: white; }
        .chart-container { height: 400px; position: relative; }
        
        .loading { text-align: center; padding: 40px; color: #666; }
        .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 4px; margin: 10px 0; border: 1px solid #f5c6cb; }
        .market-status { display: inline-block; padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; }
        .market-open { background: #d4edda; color: #155724; }
        .market-closed { background: #f8d7da; color: #721c24; }
        .data-source { font-size: 12px; color: #666; margin-top: 10px; text-align: right; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="stock-header">
                <div class="stock-info">
                    <div class="stock-symbol" id="stockSymbol">-</div>
                    <div class="company-name" id="companyName">Cargando...</div>
                    <div id="marketStatus" class="market-status market-open">Mercado Abierto</div>
                </div>
                <div style="text-align: right;">
                    <div class="current-price" id="currentPrice">$0.00</div>
                    <div class="price-change" id="priceChange">+$0.00 (+0.00%)</div>
                    <div class="data-source" id="dataSource">Fuente: simulado</div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="buyThisStock()">üí∞ Comprar</button>
                    <button class="btn btn-primary" onclick="addToWatchlist()">‚≠ê Seguir</button>
                    <button class="btn btn-secondary" onclick="goBack()">‚Üê Volver</button>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>üìä Informaci√≥n del Precio</h3>
                <div id="priceStats">
                    <div class="loading">Cargando estad√≠sticas...</div>
                </div>
            </div>

            <div class="stat-card">
                <h3>üìà Rendimiento</h3>
                <div id="performanceStats">
                    <div class="loading">Calculando rendimiento...</div>
                </div>
            </div>

            <div class="stat-card">
                <h3>üíº Informaci√≥n Corporativa</h3>
                <div id="corporateInfo">
                    <div class="loading">Obteniendo informaci√≥n...</div>
                </div>
            </div>
        </div>

        <div class="chart-section">
            <h3>üìà Gr√°fico de Precio Hist√≥rico</h3>
            <div class="chart-controls">
                <div class="chart-group">
                    <label>Per√≠odo de Tiempo</label>
                    <select id="timePeriod" onchange="updateChart()">
                        <option value="1d">1 D√≠a</option>
                        <option value="5d">5 D√≠as</option>
                        <option value="1mo" selected>1 Mes</option>
                        <option value="3mo">3 Meses</option>
                        <option value="6mo">6 Meses</option>
                        <option value="1y">1 A√±o</option>
                        <option value="2y">2 A√±os</option>
                        <option value="5y">5 A√±os</option>
                    </select>
                </div>
                <div class="chart-group">
                    <label>Intervalo de Datos</label>
                    <select id="dataInterval" onchange="updateChart()">
                        <option value="1m">1 Minuto</option>
                        <option value="5m">5 Minutos</option>
                        <option value="15m">15 Minutos</option>
                        <option value="1h">1 Hora</option>
                        <option value="1d" selected>1 D√≠a</option>
                        <option value="1wk">1 Semana</option>
                        <option value="1mo">1 Mes</option>
                    </select>
                </div>
                <div class="chart-group">
                    <label>Vista R√°pida</label>
                    <div class="quick-range-buttons">
                        <button class="quick-range-btn" onclick="setQuickRange('1d', '1m')">Hoy</button>
                        <button class="quick-range-btn" onclick="setQuickRange('5d', '15m')">5D</button>
                        <button class="quick-range-btn active" onclick="setQuickRange('1mo', '1d')">1M</button>
                        <button class="quick-range-btn" onclick="setQuickRange('3mo', '1d')">3M</button>
                        <button class="quick-range-btn" onclick="setQuickRange('1y', '1wk')">1A</button>
                    </div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="priceChart"></canvas>
            </div>
        </div>

        <div id="message"></div>
    </div>

    <script>
        let stockSymbol = null;
        let stockData = null;
        let priceChart = null;
        const userId = localStorage.getItem('userId');

        // Get stock symbol from URL parameters
        function getStockSymbolFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('symbol');
        }

        // Initialize page
        async function initializePage() {
            stockSymbol = getStockSymbolFromURL();
            
            if (!stockSymbol) {
                showError('No se especific√≥ ninguna acci√≥n');
                return;
            }

            document.getElementById('stockSymbol').textContent = stockSymbol;
            await loadStockData();
        }

        // Load all stock data
        async function loadStockData() {
            try {
                await Promise.all([
                    loadStockPrice(),
                    loadStockStats(),
                    loadMarketStatus()
                ]);
                
                // Load chart after basic data is loaded
                await updateChart();
            } catch (error) {
                console.error('Error loading stock data:', error);
                showError('Error cargando datos de la acci√≥n');
            }
        }

        // Load current stock price and basic info
        async function loadStockPrice() {
            try {
                const response = await fetch(`/api/market/stock-price/${stockSymbol}`);
                const result = await response.json();

                if (result.success) {
                    stockData = result.data;
                    displayStockPrice(stockData);
                } else {
                    throw new Error('No se pudo obtener el precio');
                }
            } catch (error) {
                console.error('Error loading stock price:', error);
                showError('Error obteniendo precio de la acci√≥n');
            }
        }

        // Display stock price information
        function displayStockPrice(data) {
            document.getElementById('companyName').textContent = data.shortName || `${stockSymbol} Inc.`;
            document.getElementById('currentPrice').textContent = `$${data.price.toFixed(2)}`;
            
            const changeClass = data.change >= 0 ? 'change-positive' : 'change-negative';
            const changeSign = data.change >= 0 ? '+' : '';
            document.getElementById('priceChange').className = `price-change ${changeClass}`;
            document.getElementById('priceChange').textContent = 
                `${changeSign}$${data.change.toFixed(2)} (${changeSign}${data.changePercent.toFixed(2)}%)`;
            
            if (data.dataSource) {
                document.getElementById('dataSource').textContent = `Fuente: ${data.dataSource}`;
            }
        }

        // Load detailed stock statistics
        async function loadStockStats() {
            try {
                // Generate comprehensive stats display
                displayPriceStats();
                displayPerformanceStats();
                displayCorporateInfo();
            } catch (error) {
                console.error('Error loading stock stats:', error);
            }
        }

        // Display price statistics
        function displayPriceStats() {
            if (!stockData) return;

            const priceStatsHTML = `
                <div class="stat-item">
                    <span class="stat-label">Precio Actual</span>
                    <span class="stat-value">$${stockData.price.toFixed(2)}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Cambio Diario</span>
                    <span class="stat-value ${stockData.change >= 0 ? 'change-positive' : 'change-negative'}">
                        ${stockData.change >= 0 ? '+' : ''}$${stockData.change.toFixed(2)}
                    </span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">% Cambio</span>
                    <span class="stat-value ${stockData.changePercent >= 0 ? 'change-positive' : 'change-negative'}">
                        ${stockData.changePercent >= 0 ? '+' : ''}${stockData.changePercent.toFixed(2)}%
                    </span>
                </div>
                ${stockData.dayHigh ? `
                <div class="stat-item">
                    <span class="stat-label">M√°ximo del D√≠a</span>
                    <span class="stat-value">$${stockData.dayHigh.toFixed(2)}</span>
                </div>
                ` : ''}
                ${stockData.dayLow ? `
                <div class="stat-item">
                    <span class="stat-label">M√≠nimo del D√≠a</span>
                    <span class="stat-value">$${stockData.dayLow.toFixed(2)}</span>
                </div>
                ` : ''}
                ${stockData.previousClose ? `
                <div class="stat-item">
                    <span class="stat-label">Cierre Anterior</span>
                    <span class="stat-value">$${stockData.previousClose.toFixed(2)}</span>
                </div>
                ` : ''}
                <div class="stat-item">
                    <span class="stat-label">Volumen</span>
                    <span class="stat-value">${stockData.volume ? stockData.volume.toLocaleString() : 'N/A'}</span>
                </div>
            `;

            document.getElementById('priceStats').innerHTML = priceStatsHTML;
        }

        // Display performance statistics
        function displayPerformanceStats() {
            if (!stockData) return;

            const performanceStatsHTML = `
                ${stockData.fiftyTwoWeekHigh ? `
                <div class="stat-item">
                    <span class="stat-label">M√°ximo 52 Semanas</span>
                    <span class="stat-value">$${stockData.fiftyTwoWeekHigh.toFixed(2)}</span>
                </div>
                ` : ''}
                ${stockData.fiftyTwoWeekLow ? `
                <div class="stat-item">
                    <span class="stat-label">M√≠nimo 52 Semanas</span>
                    <span class="stat-value">$${stockData.fiftyTwoWeekLow.toFixed(2)}</span>
                </div>
                ` : ''}
                <div class="stat-item">
                    <span class="stat-label">Volatilidad Estimada</span>
                    <span class="stat-value">${calculateVolatility()}%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Tendencia</span>
                    <span class="stat-value ${stockData.changePercent >= 0 ? 'change-positive' : 'change-negative'}">
                        ${getTrendIndicator()}
                    </span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">√öltima Actualizaci√≥n</span>
                    <span class="stat-value">${new Date().toLocaleTimeString()}</span>
                </div>
            `;

            document.getElementById('performanceStats').innerHTML = performanceStatsHTML;
        }

        // Display corporate information
        function displayCorporateInfo() {
            if (!stockData) return;

            const corporateInfoHTML = `
                <div class="stat-item">
                    <span class="stat-label">S√≠mbolo</span>
                    <span class="stat-value">${stockData.symbol}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Nombre</span>
                    <span class="stat-value">${stockData.shortName || 'N/A'}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Moneda</span>
                    <span class="stat-value">${stockData.currency || 'USD'}</span>
                </div>
                ${stockData.exchangeName ? `
                <div class="stat-item">
                    <span class="stat-label">Bolsa</span>
                    <span class="stat-value">${stockData.exchangeName}</span>
                </div>
                ` : ''}
                ${stockData.marketCap ? `
                <div class="stat-item">
                    <span class="stat-label">Cap. de Mercado</span>
                    <span class="stat-value">$${formatMarketCap(stockData.marketCap)}</span>
                </div>
                ` : ''}
                <div class="stat-item">
                    <span class="stat-label">Sector</span>
                    <span class="stat-value">${getSectorFromSymbol(stockData.symbol)}</span>
                </div>
            `;

            document.getElementById('corporateInfo').innerHTML = corporateInfoHTML;
        }

        // Load market status
        async function loadMarketStatus() {
            try {
                const response = await fetch('/api/market/market-data');
                const result = await response.json();

                if (result.success && result.data.marketStatus) {
                    const statusElement = document.getElementById('marketStatus');
                    const status = result.data.marketStatus;
                    
                    statusElement.textContent = getMarketStatusText(status);
                    statusElement.className = `market-status ${status === 'OPEN' ? 'market-open' : 'market-closed'}`;
                }
            } catch (error) {
                console.error('Error loading market status:', error);
            }
        }

        // Update price chart
        async function updateChart() {
            const timePeriod = document.getElementById('timePeriod').value;
            const dataInterval = document.getElementById('dataInterval').value;

            try {
                const response = await fetch(`/api/market/historical-data/${stockSymbol}?period=${timePeriod}&interval=${dataInterval}`);
                const result = await response.json();

                if (result.success && result.data && result.data.data) {
                    createPriceChart(result.data.data, timePeriod, dataInterval);
                } else {
                    // Generate simulated historical data
                    const simulatedData = generateSimulatedHistoricalData(timePeriod);
                    createPriceChart(simulatedData, timePeriod, dataInterval, true);
                }
            } catch (error) {
                console.error('Error loading historical data:', error);
                const simulatedData = generateSimulatedHistoricalData(timePeriod);
                createPriceChart(simulatedData, timePeriod, dataInterval, true);
            }
        }

        // Create price chart
        function createPriceChart(data, period, interval, isSimulated = false) {
            const ctx = document.getElementById('priceChart');
            
            if (priceChart) {
                priceChart.destroy();
            }

            const chartData = data.map(point => ({
                x: new Date(point.date).getTime(),
                y: point.close
            }));

            const getTimeUnit = (interval) => {
                if (['1m', '5m', '15m', '30m'].includes(interval)) return 'minute';
                if (['1h'].includes(interval)) return 'hour';
                if (['1d'].includes(interval)) return 'day';
                if (['1wk'].includes(interval)) return 'week';
                if (['1mo'].includes(interval)) return 'month';
                return 'day';
            };

            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: `${stockSymbol} - Precio`,
                        data: chartData,
                        borderColor: stockData && stockData.changePercent >= 0 ? '#28a745' : '#dc3545',
                        backgroundColor: stockData && stockData.changePercent >= 0 ? 'rgba(40, 167, 69, 0.1)' : 'rgba(220, 53, 69, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        borderDash: isSimulated ? [5, 5] : [],
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${stockSymbol} - Per√≠odo: ${period.toUpperCase()} | Intervalo: ${interval.toUpperCase()}${isSimulated ? ' (Simulado)' : ''}`,
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            callbacks: {
                                label: function(context) {
                                    return `Precio: $${context.parsed.y.toFixed(2)}`;
                                },
                                title: function(context) {
                                    const date = new Date(context[0].parsed.x);
                                    return date.toLocaleDateString() + ' ' + 
                                           (getTimeUnit(interval) === 'minute' || getTimeUnit(interval) === 'hour' ? 
                                            date.toLocaleTimeString() : '');
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: getTimeUnit(interval),
                                displayFormats: {
                                    minute: 'HH:mm',
                                    hour: 'MMM dd HH:mm',
                                    day: 'MMM dd',
                                    week: 'MMM dd',
                                    month: 'MMM yyyy'
                                }
                            },
                            grid: { color: 'rgba(0,0,0,0.1)' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Precio ($)',
                                font: { weight: 'bold' }
                            },
                            grid: { color: 'rgba(0,0,0,0.1)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        }
                    },
                    animation: { duration: 1000, easing: 'easeInOutQuart' }
                }
            });
        }

        // Generate simulated historical data
        function generateSimulatedHistoricalData(period) {
            const days = period === '1d' ? 1 : 
                       period === '5d' ? 5 : 
                       period === '1mo' ? 30 : 
                       period === '3mo' ? 90 : 
                       period === '6mo' ? 180 : 
                       period === '1y' ? 365 : 30;

            const data = [];
            const basePrice = stockData ? stockData.price : 100;
            let currentPrice = basePrice;
            const volatility = 0.025;

            for (let i = days; i >= 0; i--) {
                const date = new Date(Date.now() - i * 24 * 60 * 60 * 1000);
                
                const dailyChange = (Math.random() - 0.5) * volatility;
                currentPrice = currentPrice * (1 + dailyChange);
                currentPrice = Math.max(currentPrice, basePrice * 0.5);

                const open = currentPrice;
                const high = open * (1 + Math.random() * 0.02);
                const low = open * (1 - Math.random() * 0.02);
                const close = low + (high - low) * Math.random();

                data.push({
                    date: date,
                    open: open,
                    high: high,
                    low: low,
                    close: close,
                    volume: Math.floor(Math.random() * 1000000) + 100000
                });

                currentPrice = close;
            }

            return data;
        }

        // Set quick range
        function setQuickRange(period, interval) {
            document.getElementById('timePeriod').value = period;
            document.getElementById('dataInterval').value = interval;
            
            document.querySelectorAll('.quick-range-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            updateChart();
        }

        // Action functions
        function buyThisStock() {
            localStorage.setItem('selectedStockForPurchase', stockSymbol);
            window.location.href = `buy-stocks.html?symbol=${stockSymbol}`;
        }

        function addToWatchlist() {
            // TODO: Implement watchlist functionality
            showMessage(`${stockSymbol} agregado a tu lista de seguimiento`, 'success');
        }

        function goBack() {
            if (document.referrer && document.referrer.includes(window.location.origin)) {
                window.history.back();
            } else {
                window.location.href = 'market.html';
            }
        }

        // Utility functions
        function calculateVolatility() {
            if (!stockData) return '2.5';
            return Math.abs(stockData.changePercent * 0.5).toFixed(1);
        }

        function getTrendIndicator() {
            if (!stockData) return 'Neutral';
            if (stockData.changePercent > 2) return 'üìà Fuertemente Alcista';
            if (stockData.changePercent > 0) return 'üìà Alcista';
            if (stockData.changePercent < -2) return 'üìâ Fuertemente Bajista';
            if (stockData.changePercent < 0) return 'üìâ Bajista';
            return '‚û°Ô∏è Neutral';
        }

        function formatMarketCap(marketCap) {
            if (marketCap >= 1e12) return (marketCap / 1e12).toFixed(1) + 'T';
            if (marketCap >= 1e9) return (marketCap / 1e9).toFixed(1) + 'B';
            if (marketCap >= 1e6) return (marketCap / 1e6).toFixed(1) + 'M';
            return marketCap.toLocaleString();
        }

        function getSectorFromSymbol(symbol) {
            const sectors = {
                'AAPL': 'Tecnolog√≠a', 'GOOGL': 'Tecnolog√≠a', 'MSFT': 'Tecnolog√≠a', 'AMZN': 'Tecnolog√≠a',
                'TSLA': 'Automotriz', 'META': 'Tecnolog√≠a', 'NVDA': 'Semiconductores',
                'JPM': 'Bancario', 'BAC': 'Bancario', 'V': 'Servicios Financieros', 'MA': 'Servicios Financieros',
                'JNJ': 'Salud', 'PFE': 'Farmac√©utico', 'KO': 'Bebidas', 'PEP': 'Bebidas',
                'XOM': 'Energ√≠a', 'CVX': 'Energ√≠a', 'WMT': 'Retail', 'HD': 'Retail'
            };
            return sectors[symbol] || 'Diversificado';
        }

        function getMarketStatusText(status) {
            const statusTexts = {
                'OPEN': 'Mercado Abierto',
                'CLOSED': 'Mercado Cerrado',
                'PRE_MARKET': 'Pre-Mercado',
                'AFTER_HOURS': 'Post-Mercado'
            };
            return statusTexts[status] || 'Estado Desconocido';
        }

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = `<div class="error">${text}</div>`;
            setTimeout(() => messageDiv.innerHTML = '', 5000);
        }

        function showError(text) {
            document.getElementById('message').innerHTML = `<div class="error">${text}</div>`;
        }

        // Initialize page when DOM loads
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>
